<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - LMS</title>
  <link rel="stylesheet" href="css/styles.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <style>
    :root {
      --navy: #0a2342;
      --navy-dark: #06162a;
      --accent: #1e90ff;
      --white: #fff;
      --light-bg: #f4f8fb;
      --card-shadow: 0 2px 8px rgba(10,35,66,0.08);
    }
    body { background: var(--light-bg); }
    .nav-wrapper { background: var(--navy) !important; position: relative; }
    .brand-logo {
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      z-index: 2;
      font-size: 2.1rem !important;
      letter-spacing: 2px;
      margin-right: 36px;
      display: flex;
      align-items: center;
    }
    .nav-wrapper ul li a { color: var(--white) !important; font-weight: 500; }
    .nav-wrapper ul li a.active, .nav-wrapper ul li a:focus, .nav-wrapper ul li a:hover {
      background: var(--accent) !important;
      color: var(--white) !important;
      border-radius: 4px;
    }
    .dashboard-cards .card {
      min-width: 200px;
      background: var(--white);
      box-shadow: var(--card-shadow);
      border-radius: 12px;
      margin-bottom: 24px;
    }
    .dashboard-cards .card .card-title {
      color: var(--navy);
      font-weight: 700;
    }
    .dashboard-cards .card h6 {
      color: var(--navy-dark);
      font-weight: 600;
    }
    .dashboard-cards .card span {
      font-size: 1.3em;
      color: var(--accent);
    }
    .btn, .btn-large, .btn-floating {
      background: var(--accent) !important;
      color: var(--white) !important;
      border-radius: 24px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(30,144,255,0.08);
      transition: background 0.2s;
    }
    .btn:hover, .btn-large:hover, .btn-floating:hover {
      background: var(--navy) !important;
      color: var(--white) !important;
    }
    .card-panel, .modal-content, .card-content {
      background: var(--white) !important;
      color: var(--navy-dark);
      border-radius: 12px;
    }
    .fixed-action-btn .btn-floating {
      background: var(--accent) !important;
      color: var(--white) !important;
    }
    .modal-content h5 { color: var(--navy); }
    .modal-footer .btn-flat { color: var(--accent) !important; }
    .tooltipped { outline: none; }
    @media (max-width: 600px) {
      .dashboard-cards .card { min-width: 100%; }
      .container { padding: 0 4px; }
    }
    .dashboard-help-card {
      margin: 24px auto 0 auto;
      max-width: 420px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(10,35,66,0.08);
      background: #fff;
      color: #06162a;
      font-size: 1rem;
      padding: 18px 24px;
      text-align: left;
    }
    .nav-flex {
      margin-left: 120px;
    }
    .lms-logo-svg svg {
      vertical-align: middle;
      margin-right: 2px;
    }
    .nav-center-wrap {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      height: 100%;
      pointer-events: none;
    }
    .center-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      pointer-events: auto;
    }
    .brand-logo {
      z-index: 3;
    }
    .dashboard-main-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
    }
    .center-cards {
      justify-content: center;
      display: flex;
      flex-wrap: wrap;
      width: 100%;
      margin-bottom: 18px;
    }
    .dashboard-cards .card {
      margin-left: 12px;
      margin-right: 12px;
    }
    .dashboard-action-btns {
      display: flex;
      gap: 18px;
      justify-content: center;
      margin-top: 18px;
    }
    /* Responsive adjustments */
    @media (max-width: 992px) {
      .center-cards {
        flex-wrap: wrap;
      }
      .dashboard-cards .card {
        min-width: 220px;
        margin: 8px auto;
      }
      .dashboard-main-center {
        padding-left: 0;
        padding-right: 0;
      }
      .center-nav {
        display: none !important;
      }
      .sidenav-trigger {
        display: inline-flex !important;
        position: absolute;
        left: 64px;
        top: 50%;
        transform: translateY(-50%);
        color: #fff;
        z-index: 4;
        cursor: pointer;
      }
    }
    @media (max-width: 768px) {
      .dashboard-main-center {
        padding-left: 0;
        padding-right: 0;
      }
      .center-cards {
        flex-direction: column;
        align-items: center;
      }
      .dashboard-cards .card {
        min-width: 90vw;
        max-width: 98vw;
        margin: 10px 0;
      }
      .dashboard-help-card {
        max-width: 98vw;
        font-size: 0.98rem;
        padding: 12px 8px;
      }
      .dashboard-action-btns {
        flex-direction: column;
        gap: 12px;
        width: 100%;
      }
      .brand-logo {
        font-size: 1.4rem !important;
        margin-left: 8px;
      }
      .nav-center-wrap {
        position: static;
        width: 100%;
      }
      .center-nav {
        flex-wrap: wrap;
        gap: 4px;
      }
    }
    @media (max-width: 480px) {
      .dashboard-cards .card {
        min-width: 98vw;
        max-width: 99vw;
        margin: 6px 0;
      }
      .dashboard-help-card {
        font-size: 0.93rem;
        padding: 8px 2px;
      }
      .brand-logo {
        font-size: 1.1rem !important;
      }
    }
    .lms-logo-mobile {
      display: none;
      width: 100%;
      margin-top: 8px;
      margin-bottom: 0;
    }
    .lms-logo-mobile a {
      color: #fff !important;
      text-decoration: none;
    }
    @media (max-width: 992px) {
      .brand-logo.lms-logo-desktop {
        display: none !important;
      }
      .lms-logo-mobile {
        display: block !important;
      }
    }
    /* Dashboard-specific nav bar overrides */
    nav.nav-wrapper {
      border-radius: 0;
      margin-bottom: 0;
      padding: 0;
    }
    #nav-mobile.center-nav {
      display: flex;
      gap: 8px;
      align-items: center;
      height: auto;
      margin: 0;
    }
    #nav-mobile.center-nav li {
      list-style: none;
      display: flex;
      align-items: center;
      height: auto;
    }
    #nav-mobile.center-nav li a {
      display: flex;
      align-items: center;
      height: auto;
      padding: 0 8px;
      font-size: 1rem;
      font-weight: 500;
      border-radius: 4px;
      transition: background 0.18s, color 0.18s;
      text-decoration: none !important;
      letter-spacing: 0.2px;
    }
    #nav-mobile.center-nav li a:hover {
      background: var(--accent) !important;
      color: #fff !important;
    }
    #nav-mobile.center-nav li.active > a {
      background: var(--accent) !important;
      color: #fff !important;
      font-weight: bold;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <nav class="nav-wrapper" style="padding-left:0;">
    <a href="#" class="brand-logo lms-logo-desktop">
      <span class="lms-logo-svg">
        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="4" y="6" width="24" height="20" rx="4" fill="#0a2342"/>
          <rect x="8" y="10" width="16" height="2.5" rx="1.25" fill="#fff"/>
          <rect x="8" y="15" width="16" height="2.5" rx="1.25" fill="#fff"/>
          <rect x="8" y="20" width="10" height="2.5" rx="1.25" fill="#fff"/>
        </svg>
      </span>
      LMS
    </a>
    <div class="lms-logo-mobile center-align">
      <a href="#" style="color:#fff;display:flex;align-items:center;justify-content:center;gap:8px;font-size:1.4rem;font-weight:700;letter-spacing:2px;">
        <span class="lms-logo-svg">
          <svg width="28" height="28" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="4" y="6" width="24" height="20" rx="4" fill="#0a2342"/>
            <rect x="8" y="10" width="16" height="2.5" rx="1.25" fill="#fff"/>
            <rect x="8" y="15" width="16" height="2.5" rx="1.25" fill="#fff"/>
            <rect x="8" y="20" width="10" height="2.5" rx="1.25" fill="#fff"/>
          </svg>
        </span>
        LMS
      </a>
    </div>
    <a href="#" data-target="mobile-nav" class="sidenav-trigger" style="display:none;"><i class="material-icons">menu</i></a>
    <div class="nav-center-wrap" style="display: flex; justify-content: center; align-items: center; width: 100%; position: absolute; left: 0; right: 0; top: 0; height: 100%; pointer-events: none;">
      <ul id="nav-mobile" class="center-nav hide-on-med-and-down" style="display: flex; justify-content: center; align-items: center; gap: 8px; pointer-events: auto;">
        <li><a href="books.html" class="tooltipped" data-tooltip="Browse Books"><i class="material-icons left">menu_book</i>Books</a></li>
        <li class="admin-only"><a href="users.html" class="tooltipped" data-tooltip="Manage Users"><i class="material-icons left">group</i>Users</a></li>
        <li><a href="issue_return.html" class="tooltipped" data-tooltip="Issue/Return Books"><i class="material-icons left">assignment_returned</i>Issue/Return</a></li>
        <li><a href="fines.html" class="tooltipped" data-tooltip="View Fines"><i class="material-icons left">attach_money</i>Fines</a></li>
        <li><a href="reservations.html" class="tooltipped" data-tooltip="Book Reservations"><i class="material-icons left">event_available</i>Reservations</a></li>
        <li><a href="ebooks.html" class="tooltipped" data-tooltip="E-Books"><i class="material-icons left">picture_as_pdf</i>E-Books</a></li>
        <li><a href="profile.html" class="tooltipped" data-tooltip="Your Profile"><i class="material-icons left">person</i>Profile</a></li>
        <li><a href="#" id="logoutBtn" class="tooltipped" data-tooltip="Logout"><i class="material-icons left">logout</i>Logout</a></li>
        <li>
          <!-- Notification Dropdown Trigger -->
          <a class="dropdown-trigger tooltipped" href="#" data-target="notif-dropdown" data-tooltip="Notifications" tabindex="0">
            <i class="material-icons">notifications</i>
            <span id="notif-count" class="new badge red">0</span>
          </a>
        </li>
      </ul>
    </div>
  </nav>
  <!-- Notification Dropdown (must be outside nav for Materialize) -->
  <ul id="notif-dropdown" class="dropdown-content"></ul>
  <div class="container" style="margin-top:30px;">
    <div class="dashboard-main-center">
      <h5 id="greeting">Welcome!</h5>
      <div class="dashboard-cards row center-cards">
        <div class="col s12 m6 l3">
          <div class="card">
            <div class="card-content center-align">
              <span class="card-title"><i class="material-icons">library_books</i></span>
              <h6>Total Books</h6>
              <span id="totalBooks">-</span>
            </div>
          </div>
        </div>
        <div class="col s12 m6 l3">
          <div class="card">
            <div class="card-content center-align">
              <span class="card-title"><i class="material-icons">assignment_turned_in</i></span>
              <h6>Issued Books</h6>
              <span id="issuedBooks">-</span>
            </div>
          </div>
        </div>
        <div class="col s12 m6 l3">
          <div class="card">
            <div class="card-content center-align">
              <span class="card-title"><i class="material-icons">check_circle</i></span>
              <h6>Available Books</h6>
              <span id="availableBooks">-</span>
            </div>
          </div>
        </div>
        <div class="col s12 m6 l3">
          <div class="card">
            <div class="card-content center-align">
              <span class="card-title"><i class="material-icons">warning</i></span>
              <h6>Overdue Books</h6>
              <span id="overdueBooks">-</span>
            </div>
          </div>
        </div>
      </div>
      <div class="dashboard-help-card card-panel center-align">
        <b>Need help?</b> Click the <b>?</b> button below or check the tooltips <i class="material-icons tiny">help_outline</i> on every button!
      </div>
      <div class="section center-align dashboard-action-btns">
        <a href="issue_return.html" class="btn-large waves-effect waves-light tooltipped" data-tooltip="Quickly issue or return a book"><i class="material-icons left">assignment_returned</i>Issue/Return Book</a>
        <a href="books.html" class="btn-large waves-effect waves-light tooltipped" data-tooltip="Browse and search books"><i class="material-icons left">menu_book</i>Browse Books</a>
      </div>
    </div>
  </div>
  <!-- Floating Help Button -->
  <div class="fixed-action-btn">
    <a class="btn-floating btn-large tooltipped" data-tooltip="Help & FAQ" href="#helpModal">
      <i class="material-icons">help_outline</i>
    </a>
  </div>
  <!-- Help Modal Structure -->
  <div id="helpModal" class="modal">
    <div class="modal-content">
      <h5>Help & FAQ</h5>
      <ul class="collection">
        <li class="collection-item">To issue a book, click the <b>Issue/Return Book</b> button and follow the steps.</li>
        <li class="collection-item">Admins can manage users and books from the navigation bar.</li>
        <li class="collection-item">Hover over any button or icon to see what it does!</li>
        <li class="collection-item">For more help, contact your librarian or admin.</li>
      </ul>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-close btn-flat">Close</a>
    </div>
  </div>
  <!-- Mobile Sidenav -->
  <ul class="sidenav" id="mobile-nav">
    <li><a href="books.html"><i class="material-icons left">menu_book</i>Books</a></li>
    <li class="admin-only"><a href="users.html"><i class="material-icons left">group</i>Users</a></li>
    <li><a href="issue_return.html"><i class="material-icons left">assignment_returned</i>Issue/Return</a></li>
    <li><a href="fines.html"><i class="material-icons left">attach_money</i>Fines</a></li>
    <li><a href="reservations.html"><i class="material-icons left">event_available</i>Reservations</a></li>
    <li><a href="ebooks.html"><i class="material-icons left">picture_as_pdf</i>E-Books</a></li>
    <li><a href="profile.html"><i class="material-icons left">person</i>Profile</a></li>
    <li><a href="#" id="logoutBtnMobile"><i class="material-icons left">logout</i>Logout</a></li>
    <li><a href="#" id="notifMobile"><i class="material-icons left">notifications</i>Notifications <span id="notif-count-mobile" class="new badge red">0</span></a></li>
  </ul>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script type="module" src="js/firebase.js"></script>
  <script type="module" src="js/utils.js"></script>
  <script type="module">
    import { getDashboardStats, logout, highlightActiveNav } from './js/utils.js';
    import { db, auth } from './js/firebase.js';
    import { collection, query, where, getDocs, updateDoc, doc as fdoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    // Ensure dropdowns, tooltips, and modals are initialized after DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      var dropdowns = document.querySelectorAll('.dropdown-trigger');
      M.Dropdown.init(dropdowns, { constrainWidth: false, coverTrigger: false, alignment: 'right' });
      var modals = document.querySelectorAll('.modal');
      M.Modal.init(modals);
      var tooltipped = document.querySelectorAll('.tooltipped');
      M.Tooltip.init(tooltipped);
      var sidenav = document.querySelectorAll('.sidenav');
      M.Sidenav.init(sidenav);
      document.getElementById('logoutBtnMobile').onclick = logout;
    });
    async function loadNotifications(userId) {
      const q = query(collection(db, "notifications"), where("userId", "==", userId), where("read", "==", false));
      const snap = await getDocs(q);
      const notifCount = document.getElementById('notif-count');
      notifCount.textContent = snap.size;
      notifCount.style.display = snap.size > 0 ? 'inline-block' : 'none';
      const dropdown = document.getElementById('notif-dropdown');
      dropdown.innerHTML = '';
      snap.forEach(docSnap => {
        const n = docSnap.data();
        const li = document.createElement('li');
        li.innerHTML = `<a href=\"#\">${n.message}</a>`;
        li.onclick = async () => {
          await updateDoc(fdoc(db, "notifications", docSnap.id), { read: true });
          loadNotifications(userId);
        };
        dropdown.appendChild(li);
      });
    }
    auth.onAuthStateChanged(async user => {
      if (user) {
        // Personalized greeting
        const userDoc = await getDoc(fdoc(db, "users", user.uid));
        const name = userDoc.exists() && userDoc.data().name ? userDoc.data().name : user.email;
        document.getElementById('greeting').textContent = `Hi, ${name}! Welcome to your dashboard.`;
        // Role-based nav
        const role = userDoc.exists() ? userDoc.data().role : null;
        if (role !== "admin") {
          document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
        }
        loadNotifications(user.uid);
      }
    });
    getDashboardStats();
    document.getElementById('logoutBtn').onclick = logout;
    highlightActiveNav();
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const navLinks = document.querySelectorAll('#nav-mobile a');
      const current = window.location.pathname.split('/').pop();
      navLinks.forEach(link => {
        if(link.getAttribute('href') === current) {
          link.parentElement.classList.add('active');
        }
      });
    });
  </script>
  <script src="js/navHighlight.js"></script>
</body>
</html> 